<p id="notice"><%= notice %></p>

<p>
  <strong>Name:</strong>
  <%= @event.name %>
</p>

<p>
  <strong>Description:</strong>
  <%= @event.description %>
</p>

<p>
  <strong>Start time:</strong>
  <%= @event.start_time %>
</p>

<p>
  <strong>End time:</strong>
  <%= @event.end_time %>
</p>

<% if current_user.admin? or current_user.chair? %>
    <%= link_to "Manage Event", '/events/manage?id='+@event.id.to_s %> |
    <%= link_to 'Edit', edit_event_path(@event) %> |
<% end %>
<%= link_to 'Back', events_path %>

<hr>
<% if current_user.user_events.where(user: current_user,event: @event).count == 0 %>
  <%= form_tag(:action => 'register', :class => 'form') do %>
    <%= hidden_field_tag 'user_id', current_user.id%>
    <%= hidden_field_tag 'event_id', @event.id%>
    <%= submit_tag "Register", :id => "submit", :name => "submit", :class => "btn btn-success form_submit", :disabled => false, :disable_with => "Please wait..." %>
  <% end %>
<% else %>
  <%= form_tag(:action => 'unregister', :class => 'form') do %>
    <%= hidden_field_tag 'user_id', current_user.id%>
    <%= hidden_field_tag 'event_id', @event.id%>
    <%= submit_tag "Unregister", :id => "submit", :name => "submit", :class => "btn btn-danger form_submit", :disabled => false, :disable_with => "Please wait..." %>
  <% end %>
<% end %>
<hr>

<h4>Activities:</h4>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Start time</th>
                <th>End time</th>
                <th colspan="3"></th>
            </tr>
        </thead>

        <tbody id='activity-rows'>
            <% @activities.each do |activity| %>
                <tr class='activity-row'
                    id='<%= activity.id %>'
                    startTime='<%= activity.start_time %>'
                    endTime='<%= activity.end_time %>'>

                    <td><%= link_to activity.name, activity %></td>
                    <td><%= activity.description %></td>
                    <td><%= activity.start_time %></td>
                    <td><%= activity.end_time %></td>
                    <td></td>
                    <td><%= link_to 'Edit', edit_activity_path(activity) %></td>
                    <td><%= link_to 'Destroy', activity, method: :delete, data: { confirm: 'Are you sure?' } %></td>
                </tr>
            <% end %>
        </tbody>
    </table>
<%= link_to 'Add Activity', "/activities/new?event_id=#{@event.id}", :class=> "btn" %>

<br>

<hr>

<h4>Forums:</h4>

<%= link_to "Create New Forum", "/forums/new?event_id=#{@event.id}" %>

<ul>
    <% @event.forums.each do |forum| %>
        <li>
            <%= link_to forum.title, '/forums/'+forum.id.to_s %>
        </li>
    <% end %>
</ul>


<%# The following is some bad hackey code, apologies to future me. %>
<% if current_user.admin? or current_user.chair? %>
    <script charset="utf-8">
        $('tbody').sortable();

        function construct_update_activities_request(event_id) {
            let activity_rows = [];
            for (const row of document.getElementsByClassName('activity-row')) {
                let rowObj = {};
                rowObj.id = row.getAttribute("id");
                rowObj.startTime = row.getAttribute("startTime");
                rowObj.endTime = row.getAttribute("startTime");

                activity_rows.push(rowObj);
            }
            return {
                'event_id': event_id,
                'activities': activity_rows
            }

        }
        function update_activities(event_id){
            let data = JSON.stringify(construct_update_activities_request(event_id));
            // TODO:
        }
    </script>

<% end %>

